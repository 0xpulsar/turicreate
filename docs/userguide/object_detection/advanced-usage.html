
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <title>Advanced Usage Â· GitBook</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.0">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="how-it-works.html" />
    
    
    <link rel="prev" href="introduction.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../sframe/introduction.html">
            
                <a href="../sframe/introduction.html">
            
                    
                    Working with data
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../sframe/tabular-data.html">
            
                <a href="../sframe/tabular-data.html">
            
                    
                    Tabular data
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1.1" data-path="../sframe/sframe-intro.html">
            
                <a href="../sframe/sframe-intro.html">
            
                    
                    Loading and Saving
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.2" data-path="../sframe/data-manipulation.html">
            
                <a href="../sframe/data-manipulation.html">
            
                    
                    Data Manipulation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.1.3" data-path="../data_formats_and_sources/sql_integration.html">
            
                <a href="../data_formats_and_sources/sql_integration.html">
            
                    
                    SQL Databases
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../sgraph/sgraph.html">
            
                <a href="../sgraph/sgraph.html">
            
                    
                    Graph data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../text/analysis.html">
            
                <a href="../text/analysis.html">
            
                    
                    Text data
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../vis/introduction.html">
            
                <a href="../vis/introduction.html">
            
                    
                    Visualization
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.4.1" data-path="../vis/gallery.html">
            
                <a href="../vis/gallery.html">
            
                    
                    Example Gallery
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4.2" data-path="../vis/use_cases.html">
            
                <a href="../vis/use_cases.html">
            
                    
                    Sample Use Cases
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../applications/intro.html">
            
                <a href="../applications/intro.html">
            
                    
                    Task focused toolkits
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../recommender/introduction.html">
            
                <a href="../recommender/introduction.html">
            
                    
                    Recommender systems
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1.1" data-path="../recommender/using-trained-models.html">
            
                <a href="../recommender/using-trained-models.html">
            
                    
                    Using models
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.1.2" data-path="../recommender/choosing-a-model.html">
            
                <a href="../recommender/choosing-a-model.html">
            
                    
                    Choosing a model
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../image_classifier/introduction.html">
            
                <a href="../image_classifier/introduction.html">
            
                    
                    Image classification
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.2.1" data-path="../image_classifier/advanced-usage.html">
            
                <a href="../image_classifier/advanced-usage.html">
            
                    
                    Advanced Usage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2.2" data-path="../image_classifier/how-it-works.html">
            
                <a href="../image_classifier/how-it-works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../image_similarity/introduction.html">
            
                <a href="../image_similarity/introduction.html">
            
                    
                    Image similarity
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="introduction.html">
            
                <a href="introduction.html">
            
                    
                    Object detection
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.3.4.1" data-path="advanced-usage.html">
            
                <a href="advanced-usage.html">
            
                    
                    Advanced Usage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4.2" data-path="how-it-works.html">
            
                <a href="how-it-works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../activity_classifier/introduction.html">
            
                <a href="../activity_classifier/introduction.html">
            
                    
                    Activity classification
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.5.1" data-path="../activity_classifier/advanced-usage.html">
            
                <a href="../activity_classifier/advanced-usage.html">
            
                    
                    Advanced Usage
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.2" data-path="../activity_classifier/export_coreml.html">
            
                <a href="../activity_classifier/export_coreml.html">
            
                    
                    Deployment to CoreML
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5.3" data-path="../activity_classifier/how-it-works.html">
            
                <a href="../activity_classifier/how-it-works.html">
            
                    
                    How it works
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../text_classifier/introduction.html">
            
                <a href="../text_classifier/introduction.html">
            
                    
                    Text classifier
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../modeling-data/intro.html">
            
                <a href="../modeling-data/intro.html">
            
                    
                    Machine learning essentials
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../supervised-learning/classifier.html">
            
                <a href="../supervised-learning/classifier.html">
            
                    
                    Classification
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1.1" data-path="../supervised-learning/boosted_trees_classifier.html">
            
                <a href="../supervised-learning/boosted_trees_classifier.html">
            
                    
                    Boosted Trees Classifier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.2" data-path="../supervised-learning/decision_tree_classifier.html">
            
                <a href="../supervised-learning/decision_tree_classifier.html">
            
                    
                    Decision Tree Classifier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.3" data-path="../supervised-learning/logistic-regression.html">
            
                <a href="../supervised-learning/logistic-regression.html">
            
                    
                    Logistic Regression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.4" data-path="../supervised-learning/knn_classifier.html">
            
                <a href="../supervised-learning/knn_classifier.html">
            
                    
                    Nearest Neighbor Classifier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.5" data-path="../supervised-learning/random_forest_classifier.html">
            
                <a href="../supervised-learning/random_forest_classifier.html">
            
                    
                    Random Forest Classifier
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.1.6" data-path="../supervised-learning/svm.html">
            
                <a href="../supervised-learning/svm.html">
            
                    
                    SVM
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../clustering/intro.html">
            
                <a href="../clustering/intro.html">
            
                    
                    Clustering
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.2.1" data-path="../clustering/kmeans.html">
            
                <a href="../clustering/kmeans.html">
            
                    
                    KMeans
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2.2" data-path="../clustering/dbscan.html">
            
                <a href="../clustering/dbscan.html">
            
                    
                    DBSCAN
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../graph_analytics/intro.html">
            
                <a href="../graph_analytics/intro.html">
            
                    
                    Graph analytics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../nearest_neighbors/nearest_neighbors.html">
            
                <a href="../nearest_neighbors/nearest_neighbors.html">
            
                    
                    Nearest neighbors
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../supervised-learning/regression.html">
            
                <a href="../supervised-learning/regression.html">
            
                    
                    Regression
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.5.1" data-path="../supervised-learning/boosted_trees_regression.html">
            
                <a href="../supervised-learning/boosted_trees_regression.html">
            
                    
                    Boosted Trees Regression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.2" data-path="../supervised-learning/decision_tree_regression.html">
            
                <a href="../supervised-learning/decision_tree_regression.html">
            
                    
                    Decision Tree Regression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.3" data-path="../supervised-learning/linear-regression.html">
            
                <a href="../supervised-learning/linear-regression.html">
            
                    
                    Linear Regression
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5.4" data-path="../supervised-learning/random_forest_regression.html">
            
                <a href="../supervised-learning/random_forest_regression.html">
            
                    
                    Random Forest Regression
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../text/intro.html">
            
                <a href="../text/intro.html">
            
                    
                    Text analysis
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../evaluation/introduction.html">
            
                <a href="../evaluation/introduction.html">
            
                    
                    Evaluating models
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../evaluation/regression.html">
            
                <a href="../evaluation/regression.html">
            
                    
                    Regression metrics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../evaluation/classification.html">
            
                <a href="../evaluation/classification.html">
            
                    
                    Classification metrics
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../deployment/introduction.html">
            
                <a href="../deployment/introduction.html">
            
                    
                    Deployment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../conclusion.html">
            
                <a href="../conclusion.html">
            
                    
                    Additional Resources
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Advanced Usage</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="advanced-usage"><a name="advanced-usage" class="plugin-anchor" href="#advanced-usage"><i class="fa fa-link" aria-hidden="true"></i></a>Advanced Usage</h1><p>This page describes evaluation metrics in more detail as well as how to deploy
your detector to an iOS or macOS app using Core ML.</p><h4 id="evaluation"><a name="evaluation" class="plugin-anchor" href="#evaluation"><i class="fa fa-link" aria-hidden="true"></i></a>Evaluation</h4><p>If you hold out ground truth data before model creation, you can use it for
quantiative model evaluation. You can do this by splitting your ground truth
data:</p><pre><code class="lang-python"><span class="hljs-keyword">import</span> turicreate <span class="hljs-keyword">as</span> tc

train, val = data.random_split(<span class="hljs-number">0.8</span>)
model = tc.object_detector.create(train)
scores = model.evaluate(val)
print(scores[<span class="hljs-string">&apos;mean_average_precision&apos;</span>])</code></pre>
<pre><code class="lang-no-highlight">0.23121281</code></pre>
<p>Note, if we run the evaluation on <code>train</code>, it will get a significantly higher
score and not be representative of how the model will perform on new data.
Let&apos;s discuss how to interpret the score 23.1%.  As we describe how this metric
is calculated, you will realize why it is hard to get a high score. As a
result, you might find that a value of 25% mAP represents a more predictive
model than it may sound.</p><p>First, we need to define what a correct prediction is.
Your model will unlikely give a bounding box that corresponds to the ground
truth perfectly, so we need a measurement of how close we are. For this,
a score called
<a href="https://en.wikipedia.org/wiki/Jaccard_index" target="_blank">intersection-over-union</a> (IoU) is
used. It is a value between 0% (no overlap) and 100% (perfect overlap). Here
are a few examples:</p><p><img alt="Examples of IoU scores" src="images/iou_examples.png"></p><p>For a prediction to be considered correct, it needs to have the correct class
label and an IoU score against the ground truth that is greater than a
pre-determined threshold. As you can see in the examples, if a precise
localization is not critically important, then a threshold of 50% may be suitable. If two
or more predictions have an IoU greater than the threshold, only one gets
designated as <em>correct</em> (true positive, TP) and the rest as <em>incorrect</em> (false
positive, FP). Ground truth bounding boxes that were completely ignored by the model are also considered <em>incorrect</em> (false negative, FN).</p><p>Based on these three types of predictions (TP/FP/FN) we can compute <a href="https://en.wikipedia.org/wiki/Precision_and_recall" target="_blank">precision
and recall</a> scores.
However, before we do this, remember that the model also associates each
prediction with a confidence score between 0% and 100% (remember the prediction
image with two dogs).  We use this by considering a <em>confidence threshold</em> and
rejecting predictions if they fall below it prior to computing TP/FP/FN.
Instead of setting this threshold manually, we calculate scores for all
possible thresholds and plot the resulting precision and recall for each
threshold value as a curve. The <em>average precision</em> is the area under this
precision and recall curve.  This metric is calculated per object class and
averaged, to compute <em>mean average precision</em> (mAP).</p><p>Remember that we had to decide an IoU threshold to compute this metric. Setting
it to 50% is what we call <code>mean_average_precision_50</code> (popularized by the <a href="http://host.robots.ox.ac.uk/pascal/VOC/" target="_blank">PASCAL
VOC</a> dataset). Use this score if precise localization is not
important. However, if precise localization is desirable, then this metric may not
differentiate between a model with sloppy and a model with precise
localization. As a remedy to this, our primary metric averages
the mAP over a range of IoU thresholds between 50% to 95% (in increments of 5
percentage points). We call this simply <code>mean_average_precision</code> (popularized by the
<a href="http://cocodataset.org/" target="_blank">COCO</a> dataset). A model that evaluates to 90% mAP at 50% IoU threshold
may only get 50% mAP at varied IoU thresholds, so the <code>mean_average_precision</code> metric tends
to report seemingly low scores even for relatively high quality models.</p><h4 id="stacked"><a name="stacked" class="plugin-anchor" href="#stacked"><i class="fa fa-link" aria-hidden="true"></i></a>Stacked annotations</h4><p>Predictions are returned in the same format as ground truth annotations. Each row
represents an image and the bounding boxes are found inside a list. We call this format
<em>unstacked</em>. It can be useful to inspect annotations (predictions or ground truth)
in a <em>stacked</em> format, where each row is a single bounding box. We provide functions
to convert between these two formats:</p><pre><code class="lang-python">predictions = model.predict(test)

predictions_stacked = tc.object_detector.util.stack_annotations(predictions)
print(predictions_stacked)</code></pre>
<pre><code class="lang-no-highlight">+--------+------------+-------+---------+---------+--------+--------+
| row_id | confidence | label |    x    |    y    | height | width  |
+--------+------------+-------+---------+---------+--------+--------+
|   0    |    0.723   |  dog  | 262.220 | 155.497 | 73.928 | 90.453 |
|   0    |    0.567   |  dog  | 85.079  | 237.647 | 82.300 | 96.486 |
+--------+------------+-------+---------+---------+--------+--------+</code></pre>
<p>You can also convert back to unstacked:</p><pre><code class="lang-python">unstacked_predictions = tc.object_detector.util.unstack_annotations(
        predictions_stacked,
        num_rows=len(test))</code></pre>
<p>This gives you the option to arrange ground truth data in stacked format and
then convert it to unstacked. The option <code>num_rows</code> is optional and is only
necessary if you have true negative images that are not represented in the
stacked format. The returned SArray <code>unstacked_predictions</code> will be identical
to <code>predictions</code>.</p><h4 id="coreml"><a name="coreml" class="plugin-anchor" href="#coreml"><i class="fa fa-link" aria-hidden="true"></i></a>Export to Core ML</h4><p>To deploy your detector to an iOS or macOS app, first export it to the Core ML
format:</p><pre><code class="lang-python">model.export_coreml(<span class="hljs-string">&apos;MyDetector.mlmodel&apos;</span>)</code></pre>
<p>This Core ML model takes an image and outputs two matrices of floating point
values, <em>confidence</em> and <em>coordinates</em>. The first one has shape N-by-C, where N
is the maximum number of bounding boxes that can be returned in a single image,
and C is the number of classes. If you index this at <em>(n, c)</em>, you get the
confidence of the <em>n</em>:th bounding box for class <em>c</em>. The other output,
<em>coordinates</em>, is N-by-4 and contains [<em>x</em>, <em>y</em>, <em>width</em>, <em>height</em>] coordinates for
each bounding box. The coordinates are expressed relative to the original input
size as values between 0 and 1. This is because it does not know the size
before it was resized to fit the neural network. To get pixel values as in Turi
Create, you have to multiply <em>x</em> and <em>width</em> by the original width <em>y</em> and
<em>height</em> by the original height.</p><p>Drag and drop <code>MyDetector.mlmodel</code> into your Xcode project and add it to your app
by ticking the appropriate Target Membership check box. An arrow next to
MyDetector should appear:</p><p><img alt="Xcode view of MyDetector.mlmodel" src="images/xcode_detector.png"></p><p>Useful meta data is stored inside the model, such as class labels:</p><pre><code class="lang-swift"><span class="hljs-keyword">let</span> mlmodel = <span class="hljs-type">MyDetector</span>()
<span class="hljs-keyword">let</span> userDefined: [<span class="hljs-type">String</span>: <span class="hljs-type">String</span>] = mlmodel.model.modelDescription.metadata[<span class="hljs-type">MLModelMetadataKey</span>.creatorDefinedKey]! <span class="hljs-keyword">as</span>! [<span class="hljs-type">String</span> : <span class="hljs-type">String</span>]
<span class="hljs-keyword">let</span> labels = userDefined[<span class="hljs-string">&quot;classes&quot;</span>]!.components(separatedBy: <span class="hljs-string">&quot;,&quot;</span>)</code></pre>
<p>The order of <code>labels</code> corresponds to the <em>confidence</em> output. The meta data
also contains a third type of threshold that we have yet to discuss:
<code>non_maximum_suppression_threshold</code>:</p><pre><code class="lang-swift"><span class="hljs-keyword">let</span> nmsThreshold = <span class="hljs-type">Float</span>(userDefined[<span class="hljs-string">&quot;non_maximum_suppression_threshold&quot;</span>]!) ?? <span class="hljs-number">0.5</span></code></pre>
<p>Before we discuss how to use this threshold, we must first make a prediction.</p><h5 id="prediction"><a name="prediction" class="plugin-anchor" href="#prediction"><i class="fa fa-link" aria-hidden="true"></i></a>Prediction</h5><p>Making a prediction is easy:</p><pre><code class="lang-swift"><span class="hljs-keyword">let</span> model = <span class="hljs-keyword">try</span> <span class="hljs-type">VNCoreMLModel</span>(<span class="hljs-keyword">for</span>: mlmodel.model)

<span class="hljs-keyword">let</span> request = <span class="hljs-type">VNCoreMLRequest</span>(model: model, completionHandler: { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] request, error <span class="hljs-keyword">in</span>
    <span class="hljs-keyword">self</span>?.processClassifications(<span class="hljs-keyword">for</span>: request, error: error)
})
request.imageCropAndScaleOption = .scaleFill</code></pre>
<p>We use <code>.scaleFill</code> that stretches the image into the native input size of the
model. If you use <code>.centerCrop</code> or <code>.scaleFit</code>, it will be a bit tricker to
correctly map the bonding box coordinate system to the original input image.</p><p>From the <code>request</code> results we get two <code>MLMultiArray</code> instances,
<code>coordinates</code> and <code>confidence</code>. For easier handling, we will convert these
results into an array of the following <code>struct</code>:</p><pre><code class="lang-swift"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Prediction</span> </span>{
    <span class="hljs-keyword">let</span> labelIndex: <span class="hljs-type">Int</span>
    <span class="hljs-keyword">let</span> confidence: <span class="hljs-type">Float</span>
    <span class="hljs-keyword">let</span> boundingBox: <span class="hljs-type">CGRect</span>
}</code></pre>
<p>While building an array of these, we might as well trim the list of predictions
by enforcing a minimum confidence threshold. This threshold is entirely up to
you and your user experience and corresponds to the <code>confidence_threshold</code>
parameter in <code>predict</code> inside Turi Create:</p><pre><code class="lang-swift"><span class="hljs-keyword">let</span> confidenceThreshold = <span class="hljs-number">0.25</span>
<span class="hljs-keyword">var</span> unorderedPredictions = [<span class="hljs-type">Prediction</span>]()
<span class="hljs-keyword">let</span> numBoundingBoxes = confidence.shape[<span class="hljs-number">0</span>].intValue
<span class="hljs-keyword">let</span> numClasses = confidence.shape[<span class="hljs-number">1</span>].intValue
<span class="hljs-keyword">let</span> confidencePointer = <span class="hljs-type">UnsafeMutablePointer</span>&lt;<span class="hljs-type">Double</span>&gt;(<span class="hljs-type">OpaquePointer</span>(confidence.dataPointer))
<span class="hljs-keyword">let</span> coordinatesPointer = <span class="hljs-type">UnsafeMutablePointer</span>&lt;<span class="hljs-type">Double</span>&gt;(<span class="hljs-type">OpaquePointer</span>(coordinates.dataPointer))
<span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..&lt;numBoundingBoxes {
    <span class="hljs-keyword">var</span> maxConfidence = <span class="hljs-number">0.0</span>
    <span class="hljs-keyword">var</span> maxIndex = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> <span class="hljs-built_in">c</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..&lt;numClasses {
        <span class="hljs-keyword">let</span> conf = confidencePointer[b * numClasses + <span class="hljs-built_in">c</span>]
        <span class="hljs-keyword">if</span> conf &gt; maxConfidence {
            maxConfidence = conf
            maxIndex = <span class="hljs-built_in">c</span>
        }
    }
    <span class="hljs-keyword">if</span> maxConfidence &gt; confidenceThreshold {
        <span class="hljs-keyword">let</span> x = coordinatesPointer[b * <span class="hljs-number">4</span>]
        <span class="hljs-keyword">let</span> y = coordinatesPointer[b * <span class="hljs-number">4</span> + <span class="hljs-number">1</span>]
        <span class="hljs-keyword">let</span> w = coordinatesPointer[b * <span class="hljs-number">4</span> + <span class="hljs-number">2</span>]
        <span class="hljs-keyword">let</span> h = coordinatesPointer[b * <span class="hljs-number">4</span> + <span class="hljs-number">3</span>]

        <span class="hljs-keyword">let</span> rect = <span class="hljs-type">CGRect</span>(x: <span class="hljs-type">CGFloat</span>(x - w/<span class="hljs-number">2</span>), y: <span class="hljs-type">CGFloat</span>(y - h/<span class="hljs-number">2</span>),
                          width: <span class="hljs-type">CGFloat</span>(w), height: <span class="hljs-type">CGFloat</span>(h))

        <span class="hljs-keyword">let</span> prediction = <span class="hljs-type">Prediction</span>(labelIndex: maxIndex,
                                    confidence: <span class="hljs-type">Float</span>(maxConfidence),
                                    boundingBox: rect)
        unorderedPredictions.append(prediction)
    }
}</code></pre>
<p>This gives us an array of predictions (<code>unorderedPredictions</code>), still in no
particular order. This array contains more predictions than returned by
<code>predict</code> in Turi Create, since we are still missing a post-processing step
called <em>non-maximum suppression</em>.</p><h5 id="non-maximum-suppression"><a name="non-maximum-suppression" class="plugin-anchor" href="#non-maximum-suppression"><i class="fa fa-link" aria-hidden="true"></i></a>Non-maximum suppression</h5><p>This step is performed automatically by <code>predict</code> in Turi Create, but it is not
performed inside the Core ML inference model, so we will have to add it
ourselves. The model is prone to predict multiple similar predictions
associated with a single object instance. Here are the results of the two
dogs without non-maximum suppression:</p><p><img alt="Two dogs each with a swarm of bounding boxes around the face" src="images/without_nms.jpg"></p><p>The algorithm is simple: Start by taking your highest-confidence prediction and
add it to your final list of predictions.
Check the IoU (see <a href="#evaluation">Evaluation</a>) between it and and all the remaining
predictions. Remove (or <em>suppress</em>) any prediction with an IoU above a
pre-determined threshold (the <code>nmsThreshold</code> we extracted from the meta data).
Repeat this procedure, now excluding predictions that you have already added
or removed. Here is a reference implementation:</p><pre><code class="lang-swift"># <span class="hljs-type">Array</span> to store <span class="hljs-keyword">final</span> predictions (after post-processing)
<span class="hljs-keyword">var</span> predictions: [<span class="hljs-type">Prediction</span>] = []
<span class="hljs-keyword">let</span> orderedPredictions = unorderedPredictions.sorted { $<span class="hljs-number">0</span>.confidence &gt; $<span class="hljs-number">1</span>.confidence }
<span class="hljs-keyword">var</span> keep = [<span class="hljs-type">Bool</span>](repeating: <span class="hljs-literal">true</span>, <span class="hljs-built_in">count</span>: orderedPredictions.<span class="hljs-built_in">count</span>)
<span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..&lt;orderedPredictions.<span class="hljs-built_in">count</span> {
    <span class="hljs-keyword">if</span> keep[i] {
        predictions.append(orderedPredictions[i])
        <span class="hljs-keyword">let</span> bbox1 = orderedPredictions[i].boundingBox
        <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> (i+<span class="hljs-number">1</span>)..&lt;orderedPredictions.<span class="hljs-built_in">count</span> {
            <span class="hljs-keyword">if</span> keep[j] {
                <span class="hljs-keyword">let</span> bbox2 = orderedPredictions[j].boundingBox
                <span class="hljs-keyword">if</span> <span class="hljs-type">IoU</span>(bbox1, bbox2) &gt; nms_threshold {
                    keep[j] = <span class="hljs-literal">false</span>
                }
            }
        }
    }
}</code></pre>
<p>The intersection-over-union can be computed as:</p><pre><code class="lang-swift"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">IoU</span><span class="hljs-params">(<span class="hljs-number">_</span> a: CGRect, <span class="hljs-number">_</span> b: CGRect)</span></span> -&gt; <span class="hljs-type">Float</span> {
    <span class="hljs-keyword">let</span> intersection = a.intersection(b)
    <span class="hljs-keyword">let</span> union = a.union(b)
    <span class="hljs-keyword">return</span> <span class="hljs-type">Float</span>((intersection.width * intersection.height) / (union.width * union.height))
}</code></pre>
<p>The array <code>predictions</code> is now the final array of predictions corresponding
to what <code>predict</code> returns in Turi Create.</p>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="introduction.html" class="navigation navigation-prev " aria-label="Previous page: Object detection">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="how-it-works.html" class="navigation navigation-next " aria-label="Next page: How it works">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Advanced Usage","level":"1.3.4.1","depth":3,"next":{"title":"How it works","level":"1.3.4.2","depth":3,"path":"object_detection/how-it-works.md","ref":"object_detection/how-it-works.md","articles":[]},"previous":{"title":"Object detection","level":"1.3.4","depth":2,"path":"object_detection/introduction.md","ref":"object_detection/introduction.md","articles":[{"title":"Advanced Usage","level":"1.3.4.1","depth":3,"path":"object_detection/advanced-usage.md","ref":"object_detection/advanced-usage.md","articles":[]},{"title":"How it works","level":"1.3.4.2","depth":3,"path":"object_detection/how-it-works.md","ref":"object_detection/how-it-works.md","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"3.2.0","theme":"default","variables":{},"plugins":["collapsible-menu@1.0.2","anchors@0.5.0","mathjax"],"pluginsConfig":{"collapsible-menu":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"fontSettings":{"theme":"white","family":"sans","size":2},"highlight":{},"mathjax":{"forceSVG":false,"version":"2.6-latest"},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"object_detection/advanced-usage.md","mtime":"2017-12-07T19:58:53.971Z","type":"markdown"},"gitbook":{"version":"3.2.0","time":"2017-12-07T21:59:31.449Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-collapsible-menu/plugin.js"></script>
        
    
        
        <script src="https://cdn.mathjax.org/mathjax/2.6-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-mathjax/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

